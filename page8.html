<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-touch-callout" content="none">
    <title>风筝放飞拍摄</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            font-family: "Noto Sans SC Regular", sans-serif;
            -webkit-transform: translate3d(0, 0, 0);
            transform: translate3d(0, 0, 0);
            will-change: transform, opacity;
        }

        html, body {
            overflow: hidden !important;
            height: 100% !important;
            touch-action: none !important;
            -webkit-overflow-scrolling: auto !important;
            -webkit-user-select: none;
        }

        body {
            background-image: url("images/2/background.jpg");
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            height: 100vh;
            overflow: hidden;
            position: fixed; /* 兜底禁止滑动 */
            width: 100%;
        }
        .container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        /* ========== 第一页（拍摄页）- 完全保留 ========== */
        #shoot-page {
            display: block;
            width: 100%;
            height: 100%;
        }
        .camera-view {
            position: absolute;
            top: 10vh;         
            left: 10vw;
            width: 80vw;
            height: 70vh;      
            border: 4px solid #a8d08d;
            background-color: #fff8e6;
            overflow: hidden;
            z-index: 1;
            max-height: 75vh;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); 
        }
        #camera-preview {
            object-fit: none;
            position: absolute;
            top: 0;
            left: 0;
            width: auto;
            height: auto;
        }
        #kite-img {
            position: absolute;
            top: 44vh;         
            left: 15vw;
            transform: rotate(15deg);
            width: 80vw;
            height: auto;
            cursor: pointer;
            z-index: 2;
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            max-width: 50vw;
            max-height: 40vh;
            --base-width:80vw;
            --base-height: auto;
            will-change: top, left, transform;
        }
        @keyframes kiteFlyCurve {
            0% {
                top:44vh;
                left: 15vw;
                transform: rotate(15deg) scale(1);
            }
            25% {
                top: 36vh;
                left:25vw;
                transform: rotate(20deg) scale(0.95);
            }
            50% {
                top: 30vh;
                left: 35vw;
                transform: rotate(25deg) scale(0.83);
            }
            75% {
                top: 24vh;
                left: 42vw;
                transform: rotate(20deg) scale(0.78);
            }
            100% {
                top: 12vh;       
                left: 40vw;
                transform: rotate(15deg) scale(0.76);
            }
        }
        @keyframes kiteFloat {
            0% { top: 12vh; }  
            50% { top: 16vh; }
            100% { top: 12vh; }
        }
        .flying {
            animation: 
                kiteFlyCurve 2.5s ease-out forwards, 
                kiteFloat 1.5s infinite ease-in-out 2.5s;
        }
        .hint {
            position: absolute;
            top: 11vh;
            left: 50%;
            transform: translateX(-50%);
            font-size: 4vw;
            color: #FFF;
            z-index: 2;
            text-align: center;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3); /* 增加文字阴影，提升可读性 */
            background-color: rgba(0, 0, 0, 0.2); /* 半透明背景，增强对比度 */
            padding: 1vw 3vw;
            border-radius: 10vw;
        }
        #shoot-btn {
            position: absolute;
            bottom: 23vh;       
            left: 50%;
            transform: translateX(-50%);
            width: 16vw;
            height: 16vw;
            border: none;
            border-radius: 50%;
            background-color: transparent;
            background-image: url("images/2/资源 57@0.5x.webp");
            background-size: 100% 100%;
            cursor: pointer;
            z-index: 99;
            transition: transform 0.1s ease; 
        }

        #shoot-btn:active {
            transform: translateX(-50%) scale(0.95); /* 点击缩小反馈 */
        }

        .shoot-text {
            position: absolute;
            bottom: 21vh;
            left: 50%;
            transform: translateX(-50%);
            font-size: 3.5vw;
            color: #FFF;
            z-index: 100;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        .music-btn {
            position: absolute;
            top: 3vh;
            right: 5vw;
            width: 7vw;
            height: 7vw;
            border-radius: 50%;
            background-color: transparent;
            background-image: url("images/2/资源 24@0.5x.webp");
            background-size: 100% 100%;
            cursor: pointer;
            z-index: 99;
            transition: transform 0.2s ease;
        }
        .music-btn.playing {
            animation: rotateMusic 3s linear infinite; /* 音乐播放旋转动画 */
        }

        @keyframes rotateMusic {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        /* ========== 第二页（预览页）- 完全保留 ========== */
        #preview-page {
            display: none;
            width: 100%;
            height: 100%;
            z-index: 100;
        }
        .preview-box {
            position: absolute;
            top: 10vh;
            left: 10vw;
            width: 80vw;
            height: 70vh;
            border: 4px solid #a8d08d;
            background-color: #fff8e6;
            overflow: hidden;
            z-index: 101;
            max-height: 75vh;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        #preview-img {
            object-fit: none;
            position: absolute;
            top: 0;
            left: 0;
            width: auto;
            height: auto;
        }
        .btn-group {
            position: absolute;
            bottom: 10vh; 
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10vw;
            z-index: 102;
        }
        .preview-btn {
            border: none;        
            background-color: transparent; 
            padding: 0;          
            text-indent: -9999px;
            overflow: hidden;    
            cursor: pointer;    
            transition: transform 0.1s ease; 
        }

        .preview-btn:active {
            transform: scale(0.95); /* 点击缩小 */
        }

        #retake-btn {
            background-image: url("images/2/资源 51@0.5x.png");
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            width: 24vw;
            height: 8vw;
        }
        #confirm-btn {
            background-image: url("images/2/资源 52@0.5x.png");
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            width: 24vw;
            height: 8vw;
        }

        /* ========== 第三页（最终页）- 核心修改：按钮间距+按钮文字 ========== */
        #final-page {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 200;
            background: inherit;
        }
        .final-photo-area {
            position: absolute;
            top: 10vh;         
            left: 10vw;        
            width: 80vw;       
            height: 70vh;      
            border: 4px solid #a8d08d; 
            background-color: transparent; 
            overflow: hidden;
            z-index: 201;
            max-height: 75vh;  
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        #final-photo {
            object-fit: none;  
            position: absolute;
            top: 0;            
            left: 0;           
            width: auto;       
            height: auto;      
            z-index: 201;
            margin: 0;
            padding: 0;
        }
        /* 预览文字样式 - 保留之前的文字大小+粗细修改 */
        .final-text-layer {
            position: absolute;
            bottom: 50vw;      
            left: 15vw;        
            z-index: 202;      
            text-align: left;  
            pointer-events: none;
        }
        .kite-text {
            font-size: 10vw;    /* 放大到10vw */
            font-weight: 400;   /* 常规粗细 */
            color: #000;
            background-color: rgba(255,255,255,0.8); 
            padding: 2vw 3vw;  
            line-height: 1.2;  
            white-space: pre-line; 
            display: inline-block;
            font-family: "Microsoft YaHei", "SimHei", "Noto Sans SC Regular", sans-serif;
            border-radius: 2vw; /* 圆角优化 */
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        /* 核心修改1：缩小按钮组间距（从10vw改为5vw） */
        .final-btn-group {
            position: absolute;
            bottom: 10vh;      
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 5vw; /* 原10vw → 5vw，按钮间距变小，可根据需求调至4vw/6vw */
            align-items: center; /* 确保图标和文字垂直居中对齐 */
            z-index: 203;
        }
        /* 核心修改2：重构按钮样式，支持图标+下方文字 */
        .final-btn {
            width: 10vw;       /* 图标宽度 */
            height: 10vw;      /* 图标高度 */
            border: none;
            background-color: transparent;
            background-size: 100% 100%; /* 图标填满按钮区域 */
            background-repeat: no-repeat;
            background-position: center top; /* 图标居上显示 */
            cursor: pointer;
            /* 新增：支持图标+文字布局 */
            display: flex;
            flex-direction: column; /* 图标在上，文字在下 */
            align-items: center;    /* 水平居中 */
            justify-content: flex-start; /* 图标靠上 */
            font-size: 3vw;      /* 下方小字大小 */
            color: #333;        /* 文字颜色（白色，适配背景） */
            padding-top: 0;        /* 清除内边距 */
            text-indent: 0;        /* 取消文字隐藏 */
            overflow: visible;     /* 显示文字 */
            line-height: 1;        /* 文字行高 */
            transition: transform 0.1s ease; /* 点击反馈 */
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }

        .final-btn:active {
            transform: scale(0.95); /* 点击缩小 */
        }

        /* 新增：按钮文字的样式（单独控制，避免影响图标） */
        .final-btn span {
            margin-top: 11vw; /* 文字和图标之间的间距 */
            display: block;  /* 确保文字独占一行 */
        }
        /* 保留按钮背景图 */
        #save-btn {
            background-image: url("images/2/资源 99@0.5x.webp");
        }
        #share-btn {
            background-image: url("images/2/资源 100@0.5x.webp");
        }
        #back-btn {
            background-image: url("images/2/资源 101@0.5x.webp");
        }

        @media screen and (max-width: 375px) {
            .hint {
                font-size: 4.5vw;
                padding: 1.5vw 4vw;
            }

            .shoot-text {
                font-size: 4vw;
            }

            #shoot-btn {
                width: 18vw;
                height: 18vw;
                bottom: 21vh;
            }

            .final-btn {
                width: 12vw;
                height: 12vw;
                font-size: 3.5vw;
            }

            .final-btn span {
                margin-top: 13vw;
            }

            .kite-text {
                font-size: 11vw;
                padding: 2.5vw 3.5vw;
            }
        }

        /* ========== 平板适配 ========== */
        @media screen and (min-width: 768px) {
            .hint {
                font-size: 2.5vw;
                padding: 0.5vw 2vw;
            }

            .shoot-text {
                font-size: 2vw;
            }

            #shoot-btn {
                width: 10vw;
                height: 10vw;
                bottom: 20vh;
            }

            .final-btn {
                width: 8vw;
                height: 8vw;
                font-size: 2vw;
            }

            .final-btn span {
                margin-top: 9vw;
            }

            .kite-text {
                font-size: 6vw;
                padding: 1.5vw 2.5vw;
            }

            .final-btn-group {
                gap: 8vw;
            }
        }

    </style>
</head>
<body>
    <div class="container">
        <!-- ========== 第一页（拍摄页）- 完全保留 ========== -->
        <div id="shoot-page">
            <div class="music-btn"></div>
            <div class="hint">对准天空<br>点击风筝放飞</div>
            <div class="camera-view" id="camera-container">
                <video id="camera-preview" autoplay playsinline muted></video>
            </div>
            <img id="kite-img" src="images/2/板子.png" alt="风筝">
            <div id="shoot-btn"></div>
            <div class="shoot-text">点击拍摄</div>
        </div>

        <!-- ========== 第二页（预览页）- 完全保留 ========== -->
        <div id="preview-page">
            <div class="music-btn"></div>
            <div class="preview-box" id="preview-container">
                <img id="preview-img" alt="拍摄的照片">
            </div>
            <div class="btn-group">
                <div class="preview-btn" id="retake-btn">重新拍摄</div>
                <div class="preview-btn" id="confirm-btn">确认选择</div>
            </div>
        </div>

        <!-- ========== 第三页（最终页）- 核心修改：按钮添加下方文字 ========== -->
        <div id="final-page">
            <div class="music-btn"></div>
            <div class="final-photo-area" id="final-photo-container">
                <img id="final-photo" alt="拍摄的照片">
            </div>
            <div class="final-text-layer">
                <div class="kite-text" id="final-text">我的
潍坊风筝</div>
            </div>
            <div class="final-btn-group">
                <!-- 修改：按钮内添加span标签显示下方小字 -->
                <button class="final-btn" id="save-btn"><span>保存</span></button>
                <button class="final-btn" id="share-btn"><span>分享</span></button>
                <button class="final-btn" id="back-btn"><span>返回</span></button>
            </div>
        </div>
    </div>

    <script>
        // ========== 核心：彻底禁止页面滑动 ==========
        document.addEventListener('DOMContentLoaded', () => {
            // 1. 拦截所有滑动行为
            document.addEventListener('touchmove', function (e) {
                e.preventDefault();
                e.stopPropagation();
            }, { passive: false });

            // 2. 拦截PC端滚轮
            document.addEventListener('wheel', function (e) {
                e.preventDefault();
                e.stopPropagation();
            }, { passive: false });

            // 3. 禁止拖拽/选中等默认行为
            document.addEventListener('dragstart', (e) => e.preventDefault());
            document.addEventListener('selectstart', (e) => e.preventDefault());

            // ========== 读取DIY风筝逻辑 ==========
            // 1. 优先读取localStorage（page7新版逻辑）
            const kiteBase64 = localStorage.getItem('diyKiteBase64');
            const kiteType = localStorage.getItem('diyKiteType') || 'swallow';

            // 2. 兼容旧版URL参数（兜底）
            const urlParams = new URLSearchParams(window.location.search);
            const encodedKite = urlParams.get('kite');

            // 3. 加载DIY风筝
            if (kiteBase64) {
                try {
                    document.getElementById('kite-img').src = kiteBase64;
                    // 用完即删，避免缓存
                    localStorage.removeItem('diyKiteBase64');
                    localStorage.removeItem('diyKiteType');
                    console.log('✅ 从localStorage加载DIY风筝成功');
                } catch (err) {
                    console.warn('localStorage加载DIY风筝失败,使用默认风筝:', err);
                    alert('DIY风筝加载失败,将使用默认风筝~');
                }
            } else if (encodedKite) {
                // 兼容旧版URL传参
                try {
                    const decodedKite = decodeURIComponent(encodedKite);
                    document.getElementById('kite-img').src = decodedKite;
                    console.log('✅ 从URL参数加载DIY风筝成功(兼容模式）');
                } catch (err) {
                    console.warn('URL参数加载DIY风筝失败,使用默认风筝:', err);
                    alert('DIY风筝加载失败,将使用默认风筝~');
                }
            } else {
                console.log(' 未检测到DIY风筝,使用默认风筝');
            }

            // ========== 音乐播放逻辑 ==========
            // 初始化音频（解决移动端播放限制）
            let bgMusic = null;
            let isMusicPlaying = false;
            const musicBtns = document.querySelectorAll('.music-btn');

            function initAudio() {
                if (bgMusic) return;
                bgMusic = new Audio('素材最终/music.m4a');
                bgMusic.loop = true;
                bgMusic.muted = true;
                bgMusic.load();
                bgMusic.play().then(() => {
                    bgMusic.pause();
                    bgMusic.muted = false;
                }).catch(err => console.log("音频预加载：", err));
            }

            // 首次触摸初始化音频
            document.addEventListener('touchstart', initAudio, { once: true });

            // 绑定音乐按钮点击
            musicBtns.forEach(btn => {
                btn.addEventListener('click', toggleMusic);
                btn.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    toggleMusic();
                }, { passive: false });
            });

            function toggleMusic() {
                if (!bgMusic) initAudio();

                try {
                    if (isMusicPlaying) {
                        bgMusic.pause();
                        musicBtns.forEach(btn => btn.classList.remove('playing'));
                    } else {
                        bgMusic.play().catch(err => {
                            console.error('音乐播放失败:', err);
                            bgMusic.load();
                            setTimeout(() => bgMusic.play(), 100);
                        });
                        musicBtns.forEach(btn => btn.classList.add('playing'));
                    }
                    isMusicPlaying = !isMusicPlaying;
                } catch (e) {
                    console.error('音乐控制异常:', e);
                }
            }

            // 页面隐藏时暂停音乐
            document.addEventListener('visibilitychange', () => {
                if (document.hidden && isMusicPlaying) {
                    bgMusic.pause();
                    musicBtns.forEach(btn => btn.classList.remove('playing'));
                    isMusicPlaying = false;
                }
            });
        });
    
        // ========== DOM元素获取 ==========
        const shootPage = document.getElementById('shoot-page');
        const previewPage = document.getElementById('preview-page');
        const finalPage = document.getElementById('final-page');
        const cameraPreview = document.getElementById('camera-preview');
        const kiteImg = document.getElementById('kite-img');
        const shootBtn = document.getElementById('shoot-btn');
        const previewImg = document.getElementById('preview-img');
        const retakeBtn = document.getElementById('retake-btn');
        const confirmBtn = document.getElementById('confirm-btn');
        const cameraContainer = document.getElementById('camera-container');
        const previewContainer = document.getElementById('preview-container');
        const finalPhoto = document.getElementById('final-photo');
        const finalPhotoContainer = document.getElementById('final-photo-container');
        const saveBtn = document.getElementById('save-btn');
        const shareBtn = document.getElementById('share-btn');
        const backBtn = document.getElementById('back-btn');
        const finalText = document.getElementById('final-text');

        let isCameraReady = false;
        let videoNativeSize = {
            width: 0,
            height: 0
        };
        let captureCanvas = null;

        // ========== 防重复点击锁 ==========
        let isShootLocked = false;
        let isConfirmLocked = false;
        let isSaveLocked = false;


        // ========== 第一、二页原有逻辑 - 优化相机初始化 ==========
        function syncVideoNativeSize() {
            if (!cameraPreview.videoWidth || !cameraPreview.videoHeight) return;
            videoNativeSize.width = cameraPreview.videoWidth;
            videoNativeSize.height = cameraPreview.videoHeight;

            cameraPreview.style.width = `${videoNativeSize.width}px`;
            cameraPreview.style.height = `${videoNativeSize.height}px`;
            
            const containerRect = cameraContainer.getBoundingClientRect();
            cameraPreview.style.left = `${(containerRect.width - videoNativeSize.width) / 2}px`;
            cameraPreview.style.top = `${(containerRect.height - videoNativeSize.height) / 2}px`;
        }

        async function initCamera() {
            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    alert('你的浏览器不支持相机功能,请使用Chrome/Edge/Firefox');
                    return;
                }

                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: window.innerWidth, max: window.innerWidth },
                        height: { ideal: window.innerHeight, max: window.innerHeight }
                    },
                    audio: false
                });

                cameraPreview.srcObject = stream;
                cameraPreview.onloadedmetadata = () => {
                    syncVideoNativeSize();
                    isCameraReady = true;
                };

                window.addEventListener('resize', syncVideoNativeSize);
                // 页面隐藏时暂停相机，节省资源
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && cameraPreview.srcObject) {
                        const tracks = cameraPreview.srcObject.getTracks();
                        tracks.forEach(track => track.enabled = false);
                    } else if (isCameraReady && cameraPreview.srcObject) {
                        const tracks = cameraPreview.srcObject.getTracks();
                        tracks.forEach(track => track.enabled = true);
                    }
                });

            } catch (err) {
                let errMsg = '';
                if (err.name === 'NotAllowedError') {
                    errMsg = '请允许相机权限（地址栏左侧相机图标→允许）';
                } else if (err.name === 'NotSupportedError') {
                    errMsg = '需在本地服务器运行(如VSCode Live Server),禁止双击HTML文件';
                } else {
                    errMsg = '相机初始化失败：' + err.message;
                }
                alert(errMsg);
                isCameraReady = false;
            }
        }

        // ========== 优化：风筝动画可重复播放 + 防重复点击 ==========
        kiteImg.addEventListener('click', () => {
            // 先移除动画类 → 强制刷新样式 → 重新添加，实现动画重播
            kiteImg.classList.remove('flying');
            void kiteImg.offsetWidth; // 关键：触发DOM重绘
            kiteImg.classList.add('flying');
        });

        kiteImg.addEventListener('touchstart', (e) => {
            e.preventDefault();
            kiteImg.classList.remove('flying');
            void kiteImg.offsetWidth;
            kiteImg.classList.add('flying');
        }, { passive: false });

        shootBtn.addEventListener('click', async () => {
            // 防重复点击
            if (isShootLocked) return;
            isShootLocked = true;
            setTimeout(() => isShootLocked = false, 1000);

            if (!isCameraReady) {
                alert('相机还未就绪！请先允许权限或等待加载');
                isShootLocked = false;
                return;
            }

            try {
                const containerRect = cameraContainer.getBoundingClientRect();
                captureCanvas = document.createElement('canvas');
                captureCanvas.width = containerRect.width;
                captureCanvas.height = containerRect.height;
                const ctx = captureCanvas.getContext('2d');

                ctx.drawImage(
                    cameraPreview,
                    0, 0,
                    videoNativeSize.width,
                    videoNativeSize.height,
                    (containerRect.width - videoNativeSize.width) / 2,
                    (containerRect.height - videoNativeSize.height) / 2,
                    videoNativeSize.width,
                    videoNativeSize.height
                );

                const kiteRect = kiteImg.getBoundingClientRect();
                const kiteOffsetX = kiteRect.left - containerRect.left;
                const kiteOffsetY = kiteRect.top - containerRect.top;
                
                ctx.save();
                ctx.translate(kiteOffsetX + kiteRect.width/2, kiteOffsetY + kiteRect.height/2);
                const transform = window.getComputedStyle(kiteImg).transform;
                if (transform !== 'none' && transform !== 'matrix(1, 0, 0, 1, 0, 0)') {
                    const transformArr = transform.match(/matrix\(([^)]+)\)/)[1].split(',').map(Number);
                    const rotateAngle = Math.atan2(transformArr[1], transformArr[0]);
                    const scale = Math.sqrt(transformArr[0] * transformArr[0] + transformArr[1] * transformArr[1]);
                    ctx.rotate(rotateAngle);
                    ctx.scale(scale, scale);
                }
                ctx.drawImage(
                    kiteImg, 
                    -kiteRect.width / 2,
                    -kiteRect.height / 2,
                    kiteRect.width,
                    kiteRect.height
                );
                ctx.restore();

                const photoDataUrl = captureCanvas.toDataURL('image/png');
                previewImg.src = photoDataUrl;
                previewImg.style.width = `${containerRect.width}px`;
                previewImg.style.height = `${containerRect.height}px`;
                previewImg.style.left = '0px';
                previewImg.style.top = '0px';

                // 切换页面
                shootPage.style.display = 'none';
                previewPage.style.display = 'block';
            } catch (drawErr) {
                alert('拍摄失败：' + drawErr.message);
                console.error('拍摄失败详情：', drawErr);
            } finally {
                isShootLocked = false;
            }
        });

        // 绑定拍摄按钮触摸事件（移动端优先）
        shootBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            shootBtn.click();
        }, { passive: false });

        retakeBtn.addEventListener('click', () => {
            kiteImg.classList.remove('flying');
            void kiteImg.offsetWidth; 
            previewPage.style.display = 'none';
            shootPage.style.display = 'block';
            syncVideoNativeSize();
            captureCanvas = null;
        });

        retakeBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            retakeBtn.click();
        }, { passive: false });

        // ========== 第三页逻辑 ==========
        function syncFinalPhotoSize() {
            if (!captureCanvas) return;
            finalPhoto.style.width = `${captureCanvas.width}px`;
            finalPhoto.style.height = `${captureCanvas.height}px`;
            finalPhoto.style.left = '0px';
            finalPhoto.style.top = '0px';
        }

        confirmBtn.addEventListener('click', () => {

            // 防重复点击
            if (isConfirmLocked) return;
            isConfirmLocked = true;
            setTimeout(() => isConfirmLocked = false, 500);

            if (!captureCanvas) {
                alert('暂无拍摄的照片！');
                isConfirmLocked = false;
                return;
            }
            finalPhoto.src = captureCanvas.toDataURL('image/png');
            syncFinalPhotoSize();
            previewPage.style.display = 'none';
            finalPage.style.display = 'block';
        });

        confirmBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            confirmBtn.click();
        }, { passive: false });

        // ========== 核心调整：固定“我的”和背景框，仅匹配“潍坊风筝”预览位置 ==========
        saveBtn.addEventListener('click', async () => {
            // 防重复点击
            if (isSaveLocked) return;
            isSaveLocked = true;
            setTimeout(() => isSaveLocked = false, 1500);

            if (!captureCanvas) {
                alert('暂无可保存的照片！');
                isSaveLocked = false;
                return;
            }

            try {
                // 新增：高清画布适配，避免文字模糊
                const dpr = window.devicePixelRatio || 1;
                const areaRect = finalPhotoContainer.getBoundingClientRect();
                const saveCanvas = document.createElement('canvas');
                saveCanvas.width = areaRect.width * dpr;
                saveCanvas.height = areaRect.height * dpr;
                const ctx = saveCanvas.getContext('2d');
                ctx.scale(dpr, dpr); // 缩放画布，提升清晰度

                // 1. 绘制拍摄的照片（含风筝）- 和预览完全一致
                ctx.drawImage(captureCanvas, 0, 0, areaRect.width, areaRect.height);

                // 2. 读取DOM信息（固定“我的”和背景框，仅调整第二行）
                const textRect = finalText.getBoundingClientRect(); // 文字元素整体位置
                const photoRect = finalPhotoContainer.getBoundingClientRect(); // 照片容器位置

                // 固定：文字相对于照片容器的偏移（背景框和“我的”位置不变）
                const textOffsetX = textRect.left - photoRect.left;
                const textOffsetY = textRect.top - photoRect.top;

                // 读取样式（自动同步CSS修改后的大小+粗细）
                const textStyle = window.getComputedStyle(finalText);
                const fontSize = parseFloat(textStyle.fontSize); // 自动读取10vw对应的像素值
                const fontWeight = textStyle.fontWeight; // 自动读取400（常规）
                const fontFamily = textStyle.fontFamily;
                const bgColor = textStyle.backgroundColor;
                const textColor = textStyle.color;
                const paddingLeft = parseFloat(textStyle.paddingLeft);
                const paddingTop = parseFloat(textStyle.paddingTop);

                // 关键：读取预览中文字的实际行高（确保“潍坊风筝”偏移和预览一致）
                const previewTextLines = finalText.textContent.trim().split('\n');
                const text1 = previewTextLines[0] || '我的';
                const text2 = previewTextLines[1] || '潍坊风筝';

                // 3. 固定绘制：背景框和“我的”位置不变（样式同步放大+变细）
                ctx.font = `${fontWeight} ${fontSize}px ${fontFamily}`; // 应用新的大小+粗细
                ctx.textAlign = 'left';
                ctx.textBaseline = 'top';

                // 固定：绘制背景框（位置/大小和预览一致，不修改）
                ctx.fillStyle = bgColor;
                ctx.fillRect(textOffsetX, textOffsetY, textRect.width, textRect.height);

                // 固定：绘制“我的”（位置不变，样式同步放大+变细）
                ctx.fillStyle = textColor;
                ctx.fillText(text1, textOffsetX + paddingLeft, textOffsetY + paddingTop);

                // 核心调整：绘制“潍坊风筝” - 精准匹配预览中的垂直位置
                const lineHeightPx = parseFloat(textStyle.lineHeight) || fontSize * 1.2;
                ctx.fillText(
                    text2,
                    textOffsetX + paddingLeft,
                    textOffsetY + paddingTop + lineHeightPx
                );

                // 4. 下载照片
                const finalDataUrl = saveCanvas.toDataURL('image/png');
                const a = document.createElement('a');
                a.href = finalDataUrl;
                a.download = `我的潍坊风筝_${new Date().getTime()}.png`;
                a.click();
                URL.revokeObjectURL(a.href);
                alert('已成功保存！');
            } catch (err) {
                alert('保存失败：' + err.message);
                console.error('保存失败详情：', err);
            } finally {
                isSaveLocked = false;
            }
        });

        saveBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            saveBtn.click();
        }, { passive: false });

        backBtn.addEventListener('click', () => {
            finalPage.style.display = 'none';
            previewPage.style.display = 'block';
        });

        backBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            backBtn.click();
        }, { passive: false });

        shareBtn.addEventListener('click', () => {
            alert('分享功能暂未开放，敬请期待！');
        });

        shareBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            shareBtn.click();
        }, { passive: false });

        // 初始化相机
        window.addEventListener('load', initCamera);

        // ========== 错误处理 ==========
        // 图片加载失败处理
        document.querySelectorAll('img').forEach(img => {
            img.onerror = function () {
                console.error(`图片加载失败: ${this.src}`);
                // 风筝图片加载失败时使用默认图
                if (this.id === 'kite-img') {
                    this.src = 'images/2/板子.png';
                }
            };
        });

        // 页面离开时清理资源
        window.addEventListener('beforeunload', () => {
            // 停止相机流
            if (cameraPreview.srcObject) {
                const tracks = cameraPreview.srcObject.getTracks();
                tracks.forEach(track => track.stop());
            }
            // 暂停音乐
            if (bgMusic) {
                bgMusic.pause();
            }
        });
    </script>
</body>
</html>